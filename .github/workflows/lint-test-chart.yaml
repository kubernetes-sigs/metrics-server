name: Lint and Test Chart

on:
  pull_request:
    paths:
      - .github/workflows/lint-test-chart.yaml
      - "charts/metrics-server/**"

jobs:
  lint-test:
    name: Lint & Test
    if: github.repository == 'kubernetes-sigs/metrics-server'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 #v3.1.0
        with:
          fetch-depth: 0

      - name: Set-up Python
        uses: actions/setup-python@2c3dd9e7e29afd70cc0950079bde6c979d1f69f9 # v4.3.1
        with:
          python-version: "3.x"

      - name: Set-up Helm
        uses: azure/setup-helm@f382f75448129b3be48f8121b9857be18d815a82 # v3.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: latest

      - name: Set-up Artifact Hub CLI
        run: |
          set -euo pipefail
          curl -Lo /tmp/ah.tar.gz https://github.com/artifacthub/hub/releases/download/v1.11.0/ah_1.11.0_linux_amd64.tar.gz
          tar -xzvf /tmp/ah.tar.gz --directory /tmp
          mv /tmp/ah /usr/local/bin/ah
          chmod +x /usr/local/bin/ah
          rm -f /tmp/ah.tar.gz

      - name: Set-up chart-testing
        uses: helm/chart-testing-action@afea100a513515fbd68b0e72a7bb0ae34cb62aec # v2.3.1

      - name: Check for changes
        id: changes
        run: |
          changed="$(ct list-changed)"
          if [[ -n "${changed}" ]]
          then
            echo "changed=${{ toJSON(true) }}" >> $GITHUB_OUTPUT
          else
            echo "changed=${{ toJSON(false) }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Artifact Hub lint
        if: fromJSON(steps.changes.outputs.changed)
        run: ah lint --kind helm || exit 1

      - name: Run chart-testing lint
        if: fromJSON(steps.changes.outputs.changed)
        run: ct lint --check-version-increment=false

      - name: Create Kind cluster
        if: fromJSON(steps.changes.outputs.changed)
        uses: helm/kind-action@9e8295d178de23cbfbd8fa16cf844eec1d773a07 # v1.4.0
        with:
          wait: 120s

      - name: Run chart-testing install
        if: fromJSON(steps.changes.outputs.changed)
        run: ct install
